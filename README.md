
# 비대면 개인과외 스토어앱

본 시스템은 MSA/DDD/Event Storming/EDA 를 포괄하는 분석/설계/구현 전단계를 커버하도록 구성한 시스템입니다.

# Table of contents

- [비대면 개인과외 스토어앱](#---)
  - [서비스 시나리오](#서비스-시나리오)
  - [분석/설계](#분석설계)
  - [구현:](#구현-)
    - [DDD 의 적용](#ddd-의-적용)
    - [폴리글랏 퍼시스턴스](#폴리글랏-퍼시스턴스)
    - [폴리글랏 프로그래밍](#폴리글랏-프로그래밍)
    - [동기식 호출 과 Fallback 처리](#동기식-호출-과-Fallback-처리)
    - [비동기식 호출 과 Eventual Consistency](#비동기식-호출-과-Eventual-Consistency)

# 서비스 시나리오

기능적 요구사항
1. 개인과외 구매고객은 비대면 개인과외를 선택하여 구매를 요청한다.
1. 구매요청 되면 결제시스템에서 결제가 완료된다.
1. 송금시스템에서 판매고객 계좌에 수수료를 제외하고 돈을 송금한다. 
1. 개인과외 판매고객은 비대면 개인과외를 등록하여 판매를 요청한다.
1. 판매승인이 요청되면 승인시스템에서 관리자가 조회한 후 승인한다.
1. 판매요청이 승인되면 강의시스템에 개인과외가 등록된다.
1. 개인과외 구매/판매완료 고객은 강의시스템에서 실시간 화상강의를 진행한다.
1. 개인과외 구매고객은 구매를 취소할 수 있다.
1. 구매가 취소되면 결제가 취소된다.
1. 개인과외 구매고객이  개인과외를 중간 중간 조회한다.
1. 개인과외 판매고객이 자신이 등록한 개인과외 상태를 중간 중간 조회한다.
1. 승인시스템 관리자가 판매 승인요청 대상을 중간 중간 조회한다.

비기능적 요구사항
1. 장애격리
    1. 결제기능이 수행되지 않더라도 구매 요청은 365일 24시간 받을 수 있어야 한다. Async (event-driven), Eventual Consistency
    1. 과외승인 기능이 수행되지 않더라도 판매 요청은 365일 24시간 받을 수 있어야 한다. Async (event-driven), Eventual Consistency
1. 성능
    1. 구매고객이 구매요청 최종상태를 스토어시스템(프론트엔드)에서 확인할 수 있어야 한다. CQRS
    1. 판매고객이 구매요청 최종상태를 스토어시스템(프론트엔드)에서 확인할 수 있어야 한다. CQRS
    1. 승인관리자가 숙소요청상태를 승인시스템(프론트엔드)에서 확인할 수 있어야 한다. CQRS

# 분석/설계

### 이벤트 도출
![캡처1](https://user-images.githubusercontent.com/63624014/81873992-e1ea3d80-95b7-11ea-81af-82dd79422780.PNG)


### 부적격 이벤트 탈락
![캡처2](https://user-images.githubusercontent.com/63624014/81874011-edd5ff80-95b7-11ea-9e7e-cad6d2afe518.png)

    - 과정중 도출된 잘못된 도메인 이벤트들을 걸러내는 작업을 수행함
      . :숙소 재고가능 확인됨", "숙소 재고불가능 확인됨" 제외 : UI 이벤트 (업무적인 의미의 이벤트 아님)


### 액터, 커맨드, 폴리시 부착
![캡처3](https://user-images.githubusercontent.com/63624014/81874027-fb8b8500-95b7-11ea-8c48-4ade5435d0cd.PNG)


### 어그리게잇으로 묶기
![캡처4](https://user-images.githubusercontent.com/63624014/81874048-06deb080-95b8-11ea-800a-1795ed782370.PNG)


### 바운디드 컨텍스트로 묶기
![캡처5](https://user-images.githubusercontent.com/63624014/81874059-10681880-95b8-11ea-96fa-21d7fc2d93e6.PNG)

    - 도메인 서열 분리
      . Core Domain : 예약 
      . Supporting Domain : 숙소관리
      . General Domain : 결제


### 폴리시의 이동과 컨텍스트 매핑
![캡처6](https://user-images.githubusercontent.com/63624014/81874092-1f4ecb00-95b8-11ea-9f23-d4de93761944.PNG)


### 1차 완성본에 대한 기능적/비기능적 요구사항을 커버하는지 검증
![캡처7](https://user-images.githubusercontent.com/63624014/81874110-27a70600-95b8-11ea-96f5-aa17e449478f.PNG)

    - 고객이 숙소를 선택하여 예약한다. (ok)
    - 예약이 발생하면 숙소관리시스템에서 관리자가 예약을 확정한다. (ok)
    - 예약이 확정되면 결제시스템에서 결제가 완료된다. --> 결제 실패시?
    - 예약이 불가하면 숙소관리시스템에서 예약을 반려한다. (ok)
    
    - 고객이 예약을 취소할 수 있다. (ok)
    - 예약이 취소되면 결제가 취소된다. (ok)
    - 고객이 숙소 예약상태를 중간중간 조회한다. (ok)
    - 관리자가 숙소 요청상태를 중간중간 조회한다. (ok)
 
    - 트랜잭션 (1)
      . 고객이 예약한 건에 대하여 관리자가 예약가능 여부를 확인한 후에 결제를 진행한다.
    - 장애격리 (2)
      . 숙소관리 기능이 수행되지 않더라도 예약은 365일 24시간 받을 수 있어야 한다. 
        [Async (event-driven), Eventual Consistency]
      . 결제시스템이 과중되면 관리자가 결제를 잠시후에 하도록 유도한다. 고객에게는 Pending상태로 보여준다. 
    - 성능 (3)
      . 고객이 숙소에 대한 최종 예약상태를 예약시스템(프론트엔드)에서 확인할 수 있어야 한다. [CQRS]
      . 관리자가 숙소요청상태를 숙소관리시스템(프론트엔드)에서 확인할 수 있어야 한다. [CQRS]

### 수정 모형    
    - 모든 요구사항을 커버함.
![캡처9](https://user-images.githubusercontent.com/63624014/81874143-368db880-95b8-11ea-88bd-da1049a610be.PNG)

    - 구현을 위해 영어로 표기함.
![캡쳐1](https://user-images.githubusercontent.com/63624014/81885052-75ca0280-95d4-11ea-918a-a2f37d1dcb18.PNG)
    

## 헥사고날 아키텍처 다이어그램 도출
![캡쳐2](https://user-images.githubusercontent.com/63624014/81885065-7ebad400-95d4-11ea-8a0a-576d81528718.PNG)



